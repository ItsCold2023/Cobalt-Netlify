var B=Object.defineProperty;var j=(r,a,e)=>a in r?B(r,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[a]=e;var g=(r,a,e)=>(j(r,typeof a!="symbol"?a+"":a,e),e);const N=globalThis.fetch,E=globalThis.WebSocket,D=globalThis.Request,T=globalThis.Response,S={prototype:{send:E.prototype.send},CLOSED:E.CLOSED,CLOSING:E.CLOSING,CONNECTING:E.CONNECTING,OPEN:E.OPEN},W=20,$=[101,204,205,304],F=[301,302,303,307,308];class M extends Error{constructor(e,t){super(t.message||t.code);g(this,"status");g(this,"body");this.status=e,this.body=t}}class G{constructor(a,e){g(this,"base");this.base=new URL(`./v${a}/`,e)}}function y(r,a){const e=(r&65535)+(a&65535);return(r>>16)+(a>>16)+(e>>16)<<16|e&65535}function q(r,a){return r<<a|r>>>32-a}function H(r,a,e,t,s,n){return y(q(y(y(a,r),y(t,n)),s),e)}function h(r,a,e,t,s,n,o){return H(a&e|~a&t,r,a,s,n,o)}function u(r,a,e,t,s,n,o){return H(a&t|e&~t,r,a,s,n,o)}function w(r,a,e,t,s,n,o){return H(a^e^t,r,a,s,n,o)}function p(r,a,e,t,s,n,o){return H(e^(a|~t),r,a,s,n,o)}function k(r,a){r[a>>5]|=128<<a%32,r[(a+64>>>9<<4)+14]=a;let e=1732584193,t=-271733879,s=-1732584194,n=271733878;for(let o=0;o<r.length;o+=16){const c=e,f=t,d=s,i=n;e=h(e,t,s,n,r[o],7,-680876936),n=h(n,e,t,s,r[o+1],12,-389564586),s=h(s,n,e,t,r[o+2],17,606105819),t=h(t,s,n,e,r[o+3],22,-1044525330),e=h(e,t,s,n,r[o+4],7,-176418897),n=h(n,e,t,s,r[o+5],12,1200080426),s=h(s,n,e,t,r[o+6],17,-1473231341),t=h(t,s,n,e,r[o+7],22,-45705983),e=h(e,t,s,n,r[o+8],7,1770035416),n=h(n,e,t,s,r[o+9],12,-1958414417),s=h(s,n,e,t,r[o+10],17,-42063),t=h(t,s,n,e,r[o+11],22,-1990404162),e=h(e,t,s,n,r[o+12],7,1804603682),n=h(n,e,t,s,r[o+13],12,-40341101),s=h(s,n,e,t,r[o+14],17,-1502002290),t=h(t,s,n,e,r[o+15],22,1236535329),e=u(e,t,s,n,r[o+1],5,-165796510),n=u(n,e,t,s,r[o+6],9,-1069501632),s=u(s,n,e,t,r[o+11],14,643717713),t=u(t,s,n,e,r[o],20,-373897302),e=u(e,t,s,n,r[o+5],5,-701558691),n=u(n,e,t,s,r[o+10],9,38016083),s=u(s,n,e,t,r[o+15],14,-660478335),t=u(t,s,n,e,r[o+4],20,-405537848),e=u(e,t,s,n,r[o+9],5,568446438),n=u(n,e,t,s,r[o+14],9,-1019803690),s=u(s,n,e,t,r[o+3],14,-187363961),t=u(t,s,n,e,r[o+8],20,1163531501),e=u(e,t,s,n,r[o+13],5,-1444681467),n=u(n,e,t,s,r[o+2],9,-51403784),s=u(s,n,e,t,r[o+7],14,1735328473),t=u(t,s,n,e,r[o+12],20,-1926607734),e=w(e,t,s,n,r[o+5],4,-378558),n=w(n,e,t,s,r[o+8],11,-2022574463),s=w(s,n,e,t,r[o+11],16,1839030562),t=w(t,s,n,e,r[o+14],23,-35309556),e=w(e,t,s,n,r[o+1],4,-1530992060),n=w(n,e,t,s,r[o+4],11,1272893353),s=w(s,n,e,t,r[o+7],16,-155497632),t=w(t,s,n,e,r[o+10],23,-1094730640),e=w(e,t,s,n,r[o+13],4,681279174),n=w(n,e,t,s,r[o],11,-358537222),s=w(s,n,e,t,r[o+3],16,-722521979),t=w(t,s,n,e,r[o+6],23,76029189),e=w(e,t,s,n,r[o+9],4,-640364487),n=w(n,e,t,s,r[o+12],11,-421815835),s=w(s,n,e,t,r[o+15],16,530742520),t=w(t,s,n,e,r[o+2],23,-995338651),e=p(e,t,s,n,r[o],6,-198630844),n=p(n,e,t,s,r[o+7],10,1126891415),s=p(s,n,e,t,r[o+14],15,-1416354905),t=p(t,s,n,e,r[o+5],21,-57434055),e=p(e,t,s,n,r[o+12],6,1700485571),n=p(n,e,t,s,r[o+3],10,-1894986606),s=p(s,n,e,t,r[o+10],15,-1051523),t=p(t,s,n,e,r[o+1],21,-2054922799),e=p(e,t,s,n,r[o+8],6,1873313359),n=p(n,e,t,s,r[o+15],10,-30611744),s=p(s,n,e,t,r[o+6],15,-1560198380),t=p(t,s,n,e,r[o+13],21,1309151649),e=p(e,t,s,n,r[o+4],6,-145523070),n=p(n,e,t,s,r[o+11],10,-1120210379),s=p(s,n,e,t,r[o+2],15,718787259),t=p(t,s,n,e,r[o+9],21,-343485551),e=y(e,c),t=y(t,f),s=y(s,d),n=y(n,i)}return[e,t,s,n]}function U(r){let a="";const e=r.length*32;for(let t=0;t<e;t+=8)a+=String.fromCharCode(r[t>>5]>>>t%32&255);return a}function v(r){const a=[],e=r.length>>2;for(let s=0;s<e;s+=1)a[s]=0;const t=r.length*8;for(let s=0;s<t;s+=8)a[s>>5]|=(r.charCodeAt(s/8)&255)<<s%32;return a}function J(r){return U(k(v(r),r.length*8))}function V(r,a){let e=v(r);const t=[],s=[];e.length>16&&(e=k(e,r.length*8));for(let o=0;o<16;o+=1)t[o]=e[o]^909522486,s[o]=e[o]^1549556828;const n=k(t.concat(v(a)),512+a.length*8);return U(k(s.concat(n),512+128))}function A(r){const a="0123456789abcdef";let e="";for(let t=0;t<r.length;t+=1){const s=r.charCodeAt(t);e+=a.charAt(s>>>4&15)+a.charAt(s&15)}return e}function L(r){return unescape(encodeURIComponent(r))}function I(r){return J(L(r))}function X(r){return A(I(r))}function P(r,a){return V(L(r),L(a))}function Y(r,a){return A(P(r,a))}function _(r,a,e){return a?e?P(a,r):Y(a,r):e?I(r):X(r)}const R=3072;function z(r){const a=new Headers(r);if(r.has("x-bare-headers")){const e=r.get("x-bare-headers");if(e.length>R){a.delete("x-bare-headers");let t=0;for(let s=0;s<e.length;s+=R){const n=e.slice(s,s+R),o=t++;a.set(`x-bare-headers-${o}`,`;${n}`)}}}return a}function K(r){const a=new Headers(r),e="x-bare-headers";if(r.has(`${e}-0`)){const t=[];for(const[s,n]of r){if(!s.startsWith(e))continue;if(!n.startsWith(";"))throw new M(400,{code:"INVALID_BARE_HEADER",id:`request.headers.${s}`,message:"Value didn't begin with semi-colon."});const o=parseInt(s.slice(e.length+1));t[o]=n.slice(1),a.delete(s)}a.set(e,t.join(""))}return a}class Q extends G{constructor(e){super(3,e);g(this,"ws");g(this,"http");this.ws=new URL(this.base),this.http=new URL(this.base),this.ws.protocol==="https:"?this.ws.protocol="wss:":this.ws.protocol="ws:"}connect(e,t,s,n,o){const c=new E(this.ws),f=()=>{c.removeEventListener("close",d),c.removeEventListener("message",i)},d=()=>{f()},i=l=>{if(f(),typeof l.data!="string")throw new TypeError("the first websocket message was not a text frame");const b=JSON.parse(l.data);if(b.type!=="open")throw new TypeError("message was not of open type");l.stopImmediatePropagation(),n({protocol:b.protocol,setCookies:b.setCookies}),o(S.OPEN),c.dispatchEvent(new Event("open"))};return c.addEventListener("close",d),c.addEventListener("message",i),c.addEventListener("open",l=>{l.stopImmediatePropagation(),o(S.CONNECTING),s().then(b=>S.prototype.send.call(c,JSON.stringify({type:"connect",remote:e.toString(),protocols:t,headers:b,forwardHeaders:[]})))},{once:!0}),c}async request(e,t,s,n,o,c){if(n.protocol.startsWith("blob:")){const m=await N(n),C=new T(m.body,m);return C.rawHeaders=Object.fromEntries(m.headers),C.rawResponse=m,C}const f={};if(t instanceof Headers)for(const[m,C]of t)f[m]=C;else for(const m in t)f[m]=t[m];const d={credentials:"omit",method:e,signal:c,duplex:"half"};o!=="only-if-cached"&&(d.cache=o),s!==void 0&&(d.body=s),d.headers=this.createBareHeaders(n,f);const i=new D(this.http+"?cache="+_(n.toString()),d),l=await N(i),b=await this.readBareResponse(l),O=new T($.includes(b.status)?void 0:l.body,{status:b.status,statusText:b.statusText??void 0,headers:new Headers(b.headers)});return O.rawHeaders=b.headers,O.rawResponse=l,O}async readBareResponse(e){if(!e.ok)throw new M(e.status,await e.json());const t=K(e.headers),s={},n=t.get("x-bare-status");n!==null&&(s.status=parseInt(n));const o=t.get("x-bare-status-text");o!==null&&(s.statusText=o);const c=t.get("x-bare-headers");return c!==null&&(s.headers=JSON.parse(c)),s}createBareHeaders(e,t,s=[],n=[],o=[]){const c=new Headers;c.set("x-bare-url",e.toString()),c.set("x-bare-headers",JSON.stringify(t));for(const f of s)c.append("x-bare-forward-headers",f);for(const f of n)c.append("x-bare-pass-headers",f);for(const f of o)c.append("x-bare-pass-status",f.toString());return z(c),c}}const Z="!#$%&'*+-.0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ^_`abcdefghijklmnopqrstuvwxyz|~";function x(r){for(let a=0;a<r.length;a++){const e=r[a];if(!Z.includes(e))return!1}return!0}const ee=[["v3",Q]];async function te(r,a){const e=await N(r,{signal:a});if(!e.ok)throw new Error(`Unable to fetch Bare meta: ${e.status} ${await e.text()}`);return await e.json()}const se=Object.getOwnPropertyDescriptor(E.prototype,"readyState").get,re=["ws:","wss:"];class ae{constructor(a,e){g(this,"manfiest");g(this,"client");g(this,"server");g(this,"working");g(this,"onDemand");g(this,"onDemandSignal");this.server=new URL(a),!e||e instanceof AbortSignal?(this.onDemand=!0,this.onDemandSignal=e):(this.onDemand=!1,this.loadManifest(e))}loadManifest(a){return this.manfiest=a,this.client=this.getClient(),this.client}demand(){return this.onDemand?(this.working||(this.working=te(this.server,this.onDemandSignal).then(a=>this.loadManifest(a)).catch(a=>{throw delete this.working,a})),this.working):this.client}getClient(){for(const[a,e]of ee)if(this.manfiest.versions.includes(a))return new e(this.server);throw new Error("Unable to find compatible client version. Starting from v2.0.0, @tomphttp/bare-client only supports Bare servers v3+. For more information, see https://github.com/tomphttp/bare-client/")}createWebSocket(a,e=[],t){if(!this.client)throw new TypeError("You need to wait for the client to finish fetching the manifest before creating any WebSockets. Try caching the manifest data before making this request.");try{a=new URL(a)}catch{throw new DOMException(`Faiiled to construct 'WebSocket': The URL '${a}' is invalid.`)}if(!re.includes(a.protocol))throw new DOMException(`Failed to construct 'WebSocket': The URL's scheme must be either 'ws' or 'wss'. '${a.protocol}' is not allowed.`);Array.isArray(e)||(e=[e]),e=e.map(String);for(const i of e)if(!x(i))throw new DOMException(`Failed to construct 'WebSocket': The subprotocol '${i}' is invalid.`);const s=this.client.connect(a,e,async()=>{const i=typeof t.headers=="function"?await t.headers():t.headers||{},l=i instanceof Headers?Object.fromEntries(i):i;return l.Host=a.host,l.Pragma="no-cache",l["Cache-Control"]="no-cache",l.Upgrade="websocket",l.Connection="Upgrade",l},i=>{n=i.protocol,t.setCookiesCallback&&t.setCookiesCallback(i.setCookies)},i=>{o=i},t.webSocketImpl||E);let n="",o=S.CONNECTING;const c=()=>{const i=se.call(s);return i===S.OPEN?o:i};t.readyStateHook?t.readyStateHook(s,c):Object.defineProperty(s,"readyState",{get:c,configurable:!0,enumerable:!0});const f=()=>{if(c()===S.CONNECTING)return new DOMException("Failed to execute 'send' on 'WebSocket': Still in CONNECTING state.")};t.sendErrorHook?t.sendErrorHook(s,f):s.send=function(...i){const l=f();if(l)throw l;S.prototype.send.call(this,...i)},t.urlHook?t.urlHook(s,a):Object.defineProperty(s,"url",{get:()=>a.toString(),configurable:!0,enumerable:!0});const d=()=>n;return t.protocolHook?t.protocolHook(s,d):Object.defineProperty(s,"protocol",{get:d,configurable:!0,enumerable:!0}),s}async fetch(a,e){const t=ne(a)?new D(a,e):a,s=(e==null?void 0:e.headers)||t.headers,n=s instanceof Headers?Object.fromEntries(s):s;let o=new URL(t.url);const c=await this.demand();for(let f=0;;f++){"host"in n?n.host=o.host:n.Host=o.host;const d=await c.request(t.method,n,t.body,o,t.cache,t.signal);d.finalURL=o.toString();const i=(e==null?void 0:e.redirect)||t.redirect;if(F.includes(d.status))switch(i){case"follow":{const l=d.headers.get("location");if(W>f&&l!==null){o=new URL(l,o);continue}else throw new TypeError("Failed to fetch")}case"error":throw new TypeError("Failed to fetch");case"manual":return d}else return d}}}function ne(r){return typeof r=="string"||r instanceof URL}export{ae as B};
